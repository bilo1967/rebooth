<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />

  <meta name="description" content="ReBooth (REmote BOOTH) is a WebRTC based platform for conference interpreter training">

  <title>ReBooth:instructor</title>

  <!-- favicon for all devices -->
  <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
  <link rel="manifest" href="/images/icons/site.webmanifest">
  <link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/images/icons/favicon.ico">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/fontawesome.min.js" integrity="sha256-NP9NujdEzS5m4ZxvNqkcbxyHB0dTRy9hG13RwTVBGwo=" crossorigin="anonymous"></script>  

  <!-- JQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <!-- Bootstrap 4.x -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
  

  <!-- AnimateCSS -->
  <link rel="stylesheet" href="css/animate.min.css">
  <script src="js/animatecss.js"></script>

  <!-- Create ZIP file -->
  <script src="js/jszip.min.js"></script>

  <!-- Bootstrap 4 alerts, confirm, prompt boxex -->
  <script src="js/bootbox.min.js"></script>

  <!-- Toastr -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

  <!-- CRC32 -->
  <script src="js/crc-32.js"></script>
  
  <!-- JSCookies-->
  <script src="js/js.cookie.js"></script>
  
  <!-- AnchorMe -->
  <script src="js/anchorme.min.js"></script>

  <!-- PeerJS -->
  <script src="js/peerjs.min.js?0.05"></script>
  
  <!-- ReBooth -->
  <link rel="stylesheet" href="css/rebooth.css?0.11">
  <script src="config/config.js?0.14"></script>
  <script src="js/common.js?0.02"></script>
  <script src="js/utils.js?0.04"></script>
  <script src="js/myrecorder.js"></script>
  <script src="js/mychrono.js"></script>
  <script src="js/log.js"></script>
  <script src="js/emojiPicker.js"></script>
  <script src="js/io-devices.js"></script>
  <script src="js/rebooth.js?0.09"></script>
  <script src="js/rebooth-file-manager.js?0.01"></script>

<style>

#shrink-booths:hover, #enlarge-booths:hover {
    opacity: 1;
}

#shrink-booths, #enlarge-booths {
    opacity: 0.75;
}

.hidden {
    display: none !important;
}    

.btn-group-xs > .btn, .btn-xs {
  padding-left: .1rem;
  padding-right: .15rem;
  padding-top: .1rem;
  padding-bottom: .25rem;
  font-size: .875rem;
  line-height: .5;
  border-radius: .2rem;
}

.video-normal {
}

#teacher {
    position: absolute;
    top: 6px;
    right: 4px;
    cursor: move;
}

#audio-player {
  height: auto !important;
  width: 100% !important;
}


#player-container {
    width: 25vw;
    height: 25vh;
    position: absolute;
    bottom: 6px;
    right: 6px;
    cursor: move;
    background: transparent;
    overflow: hidden;
}


.booth-header {
    height: 24px !important;
    font-size: 0.9rem !important;
    padding-top: 1px !important;
}


.file-item:hover {
    background: #ffffd0 !important;
}


.file-item-description {
    background: transparent !important;
}



body {

    background: #0F1F3F;

}



.head-panel {
    background: rgba(56,9,121,0.25);
    color: white;
}

.booth-video-container {
    position: absolute;
    background: transparent;
    width: 100%;
    height: var(--video-height);
}

/* vertical overflow scroller at left */
#log-board-container {
    height: 153px;
    max-height: 153px;
    overflow-y: scroll;
    direction: rtl; 
    padding-left: 4px;
}
#log-board-container:hover {
    z-index: 10;
   
}


#log-board {
    direction: ltr; 
}


.log-item-info {
    color: DarkOliveGreen;
}

.log-item-warning {
    color: MidnightBlue;
    font-style: italic;
}

.log-item-error {
    color: brown;
    //font-weight: bold;
}

.log-board-item {
    font-size: 0.75rem;
}



</style>
  
<script>
var invitations = JSON.parse('<?=$_SESSION["invitations"]?>');

const userName        = '<?=@$_SESSION["user"]?>';
const classCode       = '<?=@$_SESSION["classCode"]?>';
const boothURL        = '<?=$CONFIG["booth_url"]?>';

const RecIdPrefix     = "rs";   // recording session prefix

var pollingIntervalTimer = null;

var me                = null; // <===
var localCameraElem   = null;
var booths            = [];

var recording         = false;

var recorderChrono    = null;

var classCall         = null;

var recordingIds      = null;

// session recording mode can be 'split' (double audio track) or 'default' (just booth)
var sessionRecordingMode = 'default';


// WebAudio API
var playerNode = null;
var playerGain = null;
var boothsGain = null;
var mixerNode = null;
var audioCtx = null;
var audioDestinationElement = null;
var audioDestinationNode = null;



// Pointers to functions to clear/pause/resume a batch activity
var clearBatch        = () => {};
var resumeBatch       = () => {};
var pauseBatch        = () => {};


// handlers for setUserMediaConstraints function
const myMediaConstraints = {
    onOk: handleMediaSuccess,
    onError: handleMediaErrors,
    noWebcamMessage: userName,   // we already know who we are...
};

// fake webcam customizations
// const fakeWebcamEmoji = String.fromCodePoint(0x1F469, 0x200D, 0x1F3EB); 
const fakeWebcamEmoji = [ '👩‍🏫', '👩‍🏫', '👩‍🏫' ,'👩‍🏫' , '👹' ]; // monster is choosen 1/5
const fakeWebcamBackground = 'rgba(124,124,200,1)'; 
const fakeWebcamColor = 'yellow';


// Session token is initialized when the page is loaded, 
// and stored on the server when the class starts to prevent 
// unauthorized uploads/downloads from the booths (or from
// a malicious script).
// It is removed from the server when the teacher logs out
// and page is closed (or reloaded, in which case it's also
// re-initialized)
// It is sent to each booth as they connect.

var sessionToken = null;

class SessionToken {

    token = null;
    members = [];
    
    constructor() {
        this.token = getPins(1, 10)[0];
        if (DebugLevel >= 2) console.log("Session token is: " + this.token);
    }
    
    addMember(m) {
        if (!this.members.includes(m)) this.members.push(m);
    }
    
    get() {
        return this.token;
    }
    
    set() {
        this.save();
    }
    
    save() {

        $.ajax({
            type: 'POST',
            url: '/actions/session-set-token',
            data: {
                token: this.token,
                members: this.members,
            },
            cache: false,
            dataType: "json",
        }).done((d) => {
            if (d.Result == "OK") {
                if (DebugLevel >= 2) console.log("Session token has been set to " + this.token);
            } else {
                // ERROR
                console.error("Could not set the session token", d);
            }
        }).fail(e => {
            // ERROR
            console.error(e);
        });
    }
    
    unset() {
        let fd = new FormData();
        
        $.ajax({
            type: 'POST',
            url: '/actions/session-unset-token',
          //data: fd,
          //processData: false,
          //contentType: false,
            dataType: "json",
        }).done((d) => {
            if (d.Result == "OK") {
                if (DebugLevel >= 2) console.log("Session token has been unset");
            } else {
                // ERROR
                console.warn("Could not unset the session token", d);
            }
        }).fail(e => {
            // ERROR
            console.error(e);
        });

    }
}











$(document).ready(function() {

    $('#emoji-picker').emojiPicker('chat-text', {
        classes: 'border rounded text-center p-1 mb-1',
        css: {
            background: '#F0F0FF',
            width: "auto",
        },
        position: 'top-right',        
    });

    recordingIds = new SessionIdGenerator(RecIdPrefix);
    
    
    keepAliveSession(); // keep alive PHP session 

    /* 
    * Initialize bootstrap custom tooltips
    *
    * The "title" tag attribute is shown as a tooltip by default
    *
    * This bootstrap library has some limitations, when dealing with dynamically
    * created elements. If you change the tooltip dynamically, in some cases, it
    * might not update when you change the "title". In these cases, you can override
    * this problem by forcing an update. This is the complete solution:
    *
    *     let title = "Foo";
    *     elem.attr('title', title)
    *         .attr('data-original-title', title)
    *         .tooltip('update')
    *         .tooltip('show');   
    *
    * In most cases, setting 'data-original-title' is enough.
    */
    $('[data-tooltip="tooltip"]').tooltip({container: 'body'}); 
    $('body').tooltip({selector: '.show-tooltip'});
    $(document).on('click', function() {
        $('[data-tooltip="tooltip"]').tooltip('hide');
    }); 
    $("input[data-tooltip='tooltip']").mouseout(function(){
      $('[data-tooltip="tooltip"]').tooltip('hide');
    });    
    
    
    // Set media file allowed extensions
    $('#file-upload').attr('accept', AllowedMediaFileExtensions.map(x => '.' + x).join(','));
    $('label[for=file-upload]').text("Choose file (" + AllowedMediaFileExtensions.join(', ') + ")");
   
    loadClock();

    // Define local camera and microphone selectors
    setDeviceSelector($('#select-video-source').get(0), 'videoinput');  // select box for video source devices
    setDeviceSelector($('#select-audio-source').get(0), 'audioinput');  // select box for audio source devices
    setDeviceSelector($('#select-audio-output').get(0), 'audiooutput'); // select box for audio output devices

    bootbox.alert({
        centerVertical: true,
        title: "Welcome to "+AppName+ " v"+AppVersion + "<br><span style='font-size: 0.55rem'>"  +
               "designed and developed by " + AppAuthor + " with the help of " + AppContributors + "<br/>" +
               "for the " + AppCompany + "</span>",
        message: "Remember that students won't be able to connect to their booths until you press the 'start the class' button.",
        callback: () => {
        
            // When no webcam is available we get a fake video stream from a canvas element...
            initFakeWebcam({
                message: 'Unusable or unavailable webcam',
                emoji: fakeWebcamEmoji,
                color: fakeWebcamColor,
                background: fakeWebcamBackground,
                onStart: (msg) => {
                    $('#teacher-video').removeClass('mirrored');
                },
                onStop: () => {
                    $('#teacher-video').addClass('mirrored');
                },
            });
        
            // We do all these initializations here because some of them (noticeably
            // the creation of an audio context) need an user interface element to be
            // actually clicked by the user. We get here when the user clicks"OK"


            // Create an audio context
            audioCtx = new AudioContext();
            
            // Create the mixer (merger) node
            mixerNode = audioCtx.createChannelMerger(2);
            
            // Create a gain node for the player (audio from the player will be routed through the nodes)
            playerGain = audioCtx.createGain();
            playerNode = audioCtx.createMediaElementSource($('#audio-player').get(0));
            playerNode.connect(playerGain);
            
            // Create a gain node for the booths: audio streams from the booths will all be linked
            // to this node in the Teacher class when a booth connects
            boothsGain = audioCtx.createGain();
            
            
            // Set the gain values
            playerGain.gain.value = PlayerGainMax;
            boothsGain.gain.value = BoothsGainMax;
            $('#audio-player').get(0).volume = 1;
            

            // Since the Web Audio API does not allow to set a specific audio device
            // as a destination, we first create a destination node that we will use
            // it as a source for a dynamic audio element, for which we can set the
            // sinkId to any device we wish.
            audioDestinationNode = audioCtx.createMediaStreamDestination();
            

            // By default we connect the gain nodes directly to the audio destination,
            // skipping the mixer. Split audio modes can be set in the audio configuration
            // dialog. 
            //
            // boothsGain.connect(mixerNode, 0, 0);  // Booths: L
            // playerGain.connect(mixerNode, 0, 1);  // Source: R
            //
            boothsGain.connect(audioDestinationNode);
            playerGain.connect(audioDestinationNode);
            
            // Connect the mixer (which at the moment has no inputs) to the audio dest. node
            mixerNode.connect(audioDestinationNode); 

            // Create a dynamic <audio> element
            audioDestinationElement = new Audio();
            
            // Our audio stream becomes the audioDestinationElement srcObject
            audioDestinationElement.srcObject = audioDestinationNode.stream;

            // Start the audioDestinationElement
            if (typeof audioDestinationElement.setSinkId === 'function') {
                // Ensure audio output element uses the choosen output device
                audioDestinationElement.setSinkId(audioOutputSelect.value).then( () => {
                    audioDestinationElement.play();
                });
            } else {
                // We are likely on a mobile device, setSinkId is not available
                audioDestinationElement.play();
            }

            // Load the audio mode cookie and override the default by
            // triggering a change in the select box
            $('#select-audio-mode').val(Cookies.get('audio-mode') || 'no');
            $('#select-audio-mode').trigger('change');

            $('#select-record-mode').val(Cookies.get('record-mode') || 'default');
            $('#select-record-mode').trigger('change');

            // Init booths and teacher
            initBooths();
            initTeacher(boothsGain);

            // Set booth polling interval function
            pollingIntervalTimer = setInterval(() => {
                if (me) {
                    me.sendToAll({info: {action: "status"}});
                    me.forEachBooth(booth => {
                        $('#booth-status-'+booth.pin+">td.booth-player-status").html('');
                        $('#booth-status-'+booth.pin+">td.booth-recorder-status").html('');
                    });
                    
                }
            }, BoothPollingInterval);
            
            getDevices()
                .then(() => {
                    $('#select-video-source').val(Cookies.get('teacher-video-source') || 'default');
                    $('#select-audio-source').val(Cookies.get('teacher-audio-source') || 'default');
                    $('#select-audio-output').val(Cookies.get('teacher-audio-output') || 'default');
           
                    setUserMediaConstraints(myMediaConstraints);
                    changeAudioDestination($('#audio-player').get(0));
                    
                    changeAudioDestination(audioDestinationElement);
                    
                    me.forEachBooth(booth => {
                        changeAudioDestination(booth.videoElement);
                    });
                })
                .catch(handleLocalMediaStreamError);

            // Checking if we're starting in class call mode or not
            // here because it can be called only after the class
            // call click event handler has been defined
            if (!me.selfMuted()) {
                activateClassCall(true);
            }

        }
    });

    if (DebugMode) {
       var init = "\n[" + (new Date()).toTimeStamp() + "] " + AppName + " " + AppVersion + " teacher log console redirection enabled\n";

        redirectConsole(init, logToServer);
    }
    
    $('.download-log-link').on('click', function(e) {
        if (debugMode) {
            this.setAttribute('href', 'data:text/plain;charset=utf-8,' + console.get());
            this.setAttribute('download', 'log.txt');
        }
    });
    
    
    $('#teacher-video-toggle').on('click', () => {
        if (toggleVideo(me.mediaStream)) {
            $('#teacher-video-toggle > i').removeClass('fa-video-slash').addClass('fa-video');
        } else {
            $('#teacher-video-toggle > i').removeClass('fa-video').addClass('fa-video-slash');
        }
    });

    // Setup logon/logoff buttons
    $('#logon').removeClass('disabled');
    $('#logoff').addClass('disabled');
    
    // Setup Record/Stop buttons
    $('#recorder-start').removeClass('disabled');
    $('#recorder-stop').addClass('disabled');



    $('#log-board').html("");
    appendLog("Welcome to " + AppName + " v" + AppVersion);


    // Make self video div draggable around
    dragElement("teacher");
    dragElement("player-container");

    recorderChrono = new MyChrono(100, (t) => {
        t = Math.floor(t / 10);
        
        $('#recorder-chrono').text(t.toMMSS());
    });

    //$('.player-control').prop('disabled', 'disabled');

    // Set title
    $('#application-name').html(AppName + " v" + AppVersion);


    sessionToken = new SessionToken();

/*    
    function viewportHeight($el) {
        var elH = $el.outerHeight(),
            H   = $(window).height(),
            r   = $el[0].getBoundingClientRect(), t=r.top, b=r.bottom;
        return Math.max(0, t>0? Math.min(elH, H-t) : Math.min(b, H));
    }
*/
    $('#enlarge-booths').on('click', function() {
        const defaultWidth = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--default-video-width'));
        const defaultHeight = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--default-video-height'));
        const aspectRatio = defaultWidth / defaultHeight;
        const largeWidth = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--large-video-width'));

    
        var w = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--video-width')) + 10;
        var h = parseInt(w / aspectRatio);
        
        if (w > largeWidth) return;
        
        $("body").get(0).style.setProperty("--video-width", w );
        $("body").get(0).style.setProperty("--video-height", h );
    
    });
    $('#shrink-booths').on('click', function() {
    
        const defaultWidth = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--default-video-width'));
        const defaultHeight = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--default-video-height'));
        const aspectRatio = defaultWidth / defaultHeight;
        const minWidth = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--tiny-video-width'));
    
        var w = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--video-width')) - 10;
        var h = parseInt(w / aspectRatio);
        
        if (w < minWidth) return;
        
        $("body").get(0).style.setProperty("--video-width", w );
        $("body").get(0).style.setProperty("--video-height", h );
    });
    
    function resizeBooths() {
    
        const defaultWidth = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--default-video-width'));
        const defaultHeight = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--default-video-height'));
        const aspectRatio = defaultWidth / defaultHeight;
        const minWidth = parseInt(getComputedStyle($("body").get(0)).getPropertyValue('--tiny-video-width'));
        
        // number of booths to display
        var count = invitations.length;
    

        // current booth element width and margins
        var boothWidth = $('.connection').outerWidth();
        var boothHMargin = $('.connection').outerWidth(true) - boothWidth;
        var boothHeight = $('.connection').outerHeight();
        var boothVMargin = $('.connection').outerHeight(true) - boothHeight;


        // visible client area of booths container
        var w = $('#booths').width();
        var h = $('#booths').height();

        // given current booth size the booth container can display a c*r grid of booths without scrolling
        var c = parseInt(w / (boothWidth  + boothHMargin));
        var r = parseInt(h / (boothHeight + boothVMargin));
        var maxCount =  c * r;

        if (count > c * r) {
            // we have more booths than those we can display without scrolling, so we need to resize 
            // we add one column, keeping the same rows and resize booths accordingly
        
            var newBoothWidth = parseInt(w / (c + 1)) - boothHMargin;
            
            if (newBoothWidth < minWidth) return;
            
            var videoHeight = parseInt($('.video-normal').height());
            
            // we resize only the video part of the booth, since header and footer are fixed
            var newVideoHeight = parseInt(newBoothWidth / aspectRatio);
            
            $("body").get(0).style.setProperty("--video-width", newBoothWidth );
            $("body").get(0).style.setProperty("--video-height", newVideoHeight );
            
            resizeBooths();
        } 
    }

    $( window ).resize(function() {
        resizeBooths();
    });
    
   
    
    function addBoothElem(pin, n, email) {
    
        if (email == "" || typeof email == 'undefined') email = classTimeBoothNamePrefix + n;
    
        let invitationLink = boothURL + "?pin=" + pin + "&t=" + userName + (classCode != '' ? '&c='+classCode : '') + "&s=" + email;
    
        // Clono il div prototipo della cabina e lo aggiungo al pannello delle connessioni
        var elem = $('#connection-prototype')
           .clone()
           .prop('id', "booth-" + pin)
           .data('pin', pin)
           .data('who', email)
           .css('display', 'block');
        $('#booths').append(elem);
        
        // Set various IDs for current booth
        $('#booth-'+pin+" .booth-video-container").prop('id', 'booth-video-controls-' + pin);
        $('#booth-'+pin+" video").prop('id', 'booth-video-' + pin);
        $('#booth-'+pin+" video").prop('poster', BoothImageUrlTemplate.replace('{n}', n));


        $('#booth-'+pin+" .card-header").prop('id', 'booth-header-' + pin).data('ord', n);
        $('#booth-'+pin+" .booth-name").prop('id', 'booth-name-' + pin).html("Booth n&#186; " + n).tooltip({title: email, placement: 'top'});
        
        $('#booth-'+pin+" .invitation-link")
            .prop('id', 'invitation-link-' + pin)
            .data('invitation-link', invitationLink)
            .attr('title', "Click to copy the invitation link for “" + email + "” (pin:" + pin + ")");

        $('#booth-'+pin+" .take-snapshot").prop('id', 'take-snapshot-' + pin);
        $('#booth-'+pin+" .kick-out").prop('id', 'kick-out-' + pin);
        $('#booth-'+pin+" .talk-to-booth").prop('id', 'talk-to-booth-' + pin);
        $('#booth-'+pin+" .download-booth-recording").prop('id', 'download-booth-recording-' + pin);
        
        
        // Add a row to the booths status log table (see status-dialog)
        $('#status-log').append(
            '<tr id="booth-status-'+pin+'">' +
              '<th>'+n+'</th>'+
              '<td class="booth-student-status">'+email+'</td>' +
              '<td class="booth-player-status"></td>' +
              '<td class="booth-recorder-status"></td>'+
            '</tr>'
        );

}
    
    
  

    function initBooths() {
        booths = [];
        let i = 1;
        $('#booths').html('');
        
        invitations.forEach((invitation) => {
        
            let pin = invitation.pin;
            let email = invitation.email;

            addBoothElem(pin, i, email);
                
            booths.push({pin: pin, videoElement: $('#booth-video-' + pin)[0]});

            if (DebugLevel >= 2) console.log("Added booth " + pin + " for " + email);
            
            i++;
        });

        resizeBooths();

    }
    

    $('#add-booth').on('click', function () {
        let newpin = null;
        do {
            const pins = getPins(1, PinLength);
            newpin = pins[0];
        } while (invitations.find(i => { return i.pin == newpin; }) !== undefined );
        

        invitations.push({pin: newpin, email: null});

        addBoothElem(newpin, invitations.length , "");
        
        resizeBooths();
        
        me.addBooth(newpin, $('#booth-video-' + newpin)[0]);
        
        if (DebugLevel >= 2) console.log("Added a booth with PIN: " + newpin);
        
    });
    
    
    function initTeacher(boothsGain = null) {

        if (me instanceof Teacher) {
            me.logoff();
            me = null;
        }
        
        sessionToken.unset();
        
        me = new Teacher(
            {
                muted: true,
                boothsGainNode: boothsGain,
                videoElement: $('#teacher-video')[0],
                // starting connection - prepare interface
                onBoothICEConnected: (pin, who) => {
                    $('#booth-'+pin+" .booth-connection").html('').css('background-color', 'transparent');
                },
                onBoothICEDisconnected: (pin, who) => {
                    $('#booth-'+pin+" .booth-connection")
                    .css('background-color', 'rgba(0, 0, 0, 0.5)')
                    .html('<div class="fa-5x text-light absolute-middle"><i class="fas fa-circle-notch fa-spin"></i></div>');
                },
                onBoothConnect: (pin, who) => {
                
                    let d = new Date();
                    if (DebugLevel >= 2) console.log(pin + " " + who + " has joined the class");
                    appendLog(who + " has joined the class (" + d.toTimeStamp() + ")");
                    
                    $('#booth-header-' + pin).removeClass('bg-info').addClass('bg-primary');
                    $('#booth-name-'+pin).html(who).tooltip({html: true, title: who, placement: 'top' });
                    
                    $('#booth-'+pin+" .take-snapshot").addClass('cursor-pointer');
                    $('#booth-'+pin+" .kick-out").removeClass('disabled').addClass('cursor-pointer');
                    
                    $('#booth-'+pin+" .booth-connection").html('').css('background-color', 'transparent');
                    
                    me.send(pin, {sessionToken: {value: sessionToken.get()}});
                    
                    sessionToken.addMember(pin);
                    sessionToken.save();
                },
                // Connection completed
                onBoothConnected: (pin, who) => {
                
                    if (DebugLevel >= 2) console.log("Booth " + pin + " connection completed");
                    
                    me.shareScreenToBooth(pin); // Safe to do even if we're not actually sharing the screen
                    
                    $('#talk-to-booth-' + pin).removeClass('disabled');
                    
                    if (classCall) {
                        me.send(pin, {info: { action: 'set-teacher-label', parameters: { value: 'class call' }} });
                    } else {
                    
                        me.forEachConnectedBooth(booth => {
                            if (booth.pin != pin && !booth.isTeacherMuted()) {
                                me.send(pin, {info: { action: 'set-teacher-label', parameters: { value: 'Teacher is talking to ' + booth.who }} });
                            }
                        
                        });
                    }
                    
                },
                onBoothDisconnect: (pin, who) => {

                    me.send(pin, {flags: {value: 'clear all flags'}});
                    clearAllFlags(pin);
                    
                    let talking = $('#booth-'+pin+' .talk-to-booth-indicator').hasClass('spinner-grow');
                    if (talking) {
                        me.sendToAll({ info: { action: 'set-teacher-label', parameters: { value: false }}});
                    }
                    
                    $('#booth-header-' + pin).removeClass('bg-primary').addClass('bg-info');
                    $('booth-name-'+pin).html("Booth n&#186; " + $('#booth-header-' + pin).data('ord')).tooltip({html: true, title: who, placement: 'top' });
                    $('#booth-'+pin+' .booth-mini-log').html('');
                    $('#booth-'+pin+' .take-snapshot').removeClass('cursor-pointer');
                    $('#booth-'+pin+' .kick-out').removeClass('cursor-pointer').addClass('disabled');
                    
                    $('#booth-'+pin+' .listen-to-booth-indicator').removeClass('spinner-grow');
                    $('#booth-'+pin+' .talk-to-booth-indicator').removeClass('spinner-grow');
                    
                    $('#booth-'+pin+' .talk-to-booth').addClass('disabled');
                    
                    $('#booth-'+pin+" .booth-connection").html('').css('background-color', 'transparent');
                    
                    let d = new Date();
                    if (DebugLevel >= 2) console.log(pin + " " + who + " disconnected");
                    appendLog(who + " disconnected (" + d.toTimeStamp() + ")");

                },
                onDataReceived: function(pin, who, data) {

                    if (data.chat) {
                    
                        animateCSS('#send-chat-text', 'heartBeat');
                        
                        if ($('#shared-chat').prop("checked") == true) {
                            me.forEachConnectedBooth(booth => {
                                if (booth.pin != pin) {
                                    booth.send({chat: {pin: pin, who: who, text: data.chat.text}});
                                    if (DebugLevel >= 2) console.log("Sending a chat message from " + pin + " to " + pin);                                
                                }
                            });
                        }

//                      if (! who.startsWith(classTimeBoothNamePrefix)) {
//                          let n = who.indexOf("@");
//                          if (n > 0) who = who.substr(0, n);
//                          who = who.trunc(15);
//                      }
                        who = who + ""; // cast to string
                        
                        writeToChat(data.chat.text, who);
                        

                    } else if (data.flags) {
                    
                        switch (data.flags.value) {
                            case "raise hand":
                                clearAllFlags(pin);
                                loadAndPlay(SoundHandRaised);
                                $('#booth-video-controls-'+pin+' .booth-flags').html(
                                    '<span class="fa-stack fa-4x text-warning">' +
                                    '<i class="fas fa-circle fa-stack-2x" style="opacity: 0.8"></i>' +
                                    '<i class="fas fa-hand-paper fa-stack-1x fa-inverse"></i>' +
                                    '</span>'
                                ); 
                                
                                break;
                            case "thumbs up":
                                clearAllFlags(pin);
                                $('#booth-video-controls-'+pin+' .booth-flags').html(
                                    '<span class="fa-stack fa-4x text-success">' +
                                    '<i class="fas fa-circle fa-stack-2x" style="opacity: 0.8"></i>' +
                                    '<i class="fas fa-thumbs-up fa-stack-1x fa-inverse"></i>' +
                                    '</span>'
                                );
                                break;
                            case "thumbs down":
                                clearAllFlags(pin);
                                $('#booth-video-controls-'+pin+' .booth-flags').html(
                                    '<span class="fa-stack fa-4x text-danger">' +
                                    '<i class="fas fa-circle fa-stack-2x" style="opacity: 0.8"></i>' +
                                    '<i class="fas fa-thumbs-down fa-stack-1x fa-inverse"></i>' +
                                    '</span>'
                                );
                                break;
                            case "clear all flags":
                                clearAllFlags(pin);
                                break;
                        
                        } 
                    } else if (data.player) {
                        $(document).trigger('booth-player-feedback', {
                            date: Date.now(),
                            pin: pin,
                            who: who,
                            action: data.player.action,
                            parameters: data.player.parameters
                        });
                    } else if (data.recorder) {
                        $(document).trigger('booth-recorder-feedback', {
                            date: Date.now(),
                            pin: pin,
                            who: who,
                            action: data.recorder.action,
                            parameters: data.recorder.parameters
                        });
                    } else if (data.info) {
                        $(document).trigger('info-feedback', {
                            date: Date.now(),
                            pin: pin,
                            who: who,
                            action: data.info.action,
                            parameters: data.info.parameters
                        });
                    } else if (data.snapshot) {
                    
                        console.log("Snapshot ready (" + data.snapshot.parameters.filename + ")");
                        downloadDataURL(data.snapshot.parameters.url, data.snapshot.parameters.filename);
                    
                    } else if (data.system) {
                        switch (data.system.value) {
                            case 'hangup':
                                let d = new Date();
                                if (DebugLevel >= 2) console.log(pin + " " + who + " has left the class");
                                appendLog(who + " has left the class (" + d.toTimeStamp() + ")");
                                break;
                        }
                    }
                    
                },

            },
            booths
        );
    } // End of init teacher function

    var boothPRS = {};
    $(document).on('info-feedback', (event, data) => {
        //let timestamp = data.timeStamp;
        let action = data.action;
        let pin = data.pin;
        let who = data.who;
        let params = data.parameters;
        
        let pf = params.playerFile ? params.playerFile : "none"; 
        let ps = params.playerStatus;
        let pt = (Math.floor(params.playerTime)+"").toHHMMSS();
        let rs = params.recorderStatus;
        let rt = (Math.floor(params.recorderTime)+"").toHHMMSS();
        
        if (pf != 'none' && pf != fileName) {
            pf = '<span style="text-decoration:line-through;">'+pf+'</span>';
        } else if (pf == 'none') {
            pf = '<em>' + pf + '</em>';
        }
        
        if (DebugLevel >= 2) {
            let f = params.playerFile ? params.playerFile : "none"; 
            
            // We don't want to flood the logs so we keep track of the player and
            // recorder status for each booth. When they switch to "paused" and "inactive"
            // we stop logging
            if (boothPRS[pin] === undefined) boothPRS[pin] = {recorder: null, player: null, file: null };
            if (boothPRS[pin].recorder != 'inactive' || boothPRS[pin].player != 'paused' && boothPRS[pin].player != 'stopped' || boothPRS[pin].file != f ) {
                console.log("Booth #" + pin + " status:" +
                            " recorder=[" + rs + "|" + rt + "]" +
                            " player=[" + f + "|" + ps + "|" + pt + "]");
            }
            boothPRS[pin].recorder = rs;
            boothPRS[pin].player = ps;
            boothPRS[pin].file = f;
        }

        $('#booth-status-'+pin+">td.booth-player-status").html(pf+' ('+ps+': '+pt+')');
        $('#booth-status-'+pin+">td.booth-recorder-status").html(rs+': '+rt);
        
        me.getBooth(pin).registry.file = params.playerFile;
        me.getBooth(pin).registry.crc = params.playerFileCRC;
    });
    


    $('#share-audio-button').on('click', () => {
    
        
    
        if (me.sharingScreen()) {
            if (DebugLevel >= 2) console.log("Teacher asked to stop sharing the screen");
            me.unshareScreen();
            $('#share-audio > i').removeClass('fa-blink');
            $('#share-audio-div').addClass('hidden');
        } else {
        
            $('#share-audio-div').removeClass('hidden');
        
            navigator.mediaDevices
                .getDisplayMedia(ScreenShareConstraints)
                .then(stream => {
                    if (DebugLevel >= 2) console.log('Screen, application or browser tab has been shared');
                    
                    if (stream.getAudioTracks().length == 0) {
                        throw new Error("You've not shared the screen or tab audio");
                        return false;
                    }
                    
                    // replace screen share video track with a fake track
                    let [ vt ] = stream.getVideoTracks();
                    stream.removeTrack(vt);
                    fakeWebcam.start("Shared audio from teacher's PC");
                    stream.addTrack(fakeWebcam.track);
                    
                    $('#share-audio > i').addClass('fa-blink');
                    animateCSS('#send-chat-text', 'heartBeat');
                    
                    stream.getAudioTracks()[0].onended = () => {
                        if (DebugLevel >= 2) console.log('Sharing audio ended');  
                        me.unshareScreen();
                        $('#share-audio > i').removeClass('fa-blink');
                    }

                    me.shareScreen(stream);

                }).catch(err => {

                    me.unshareScreen();
                    $('#share-audio > i').removeClass('fa-blink');
                    
                    $('#share-audio-div').addClass('hidden');

                    console.error("Error sharing audio: " + err);
                    return null; 
                });
        }

    });


    
    $('#share-screen').on('click', () => {
    
        if (me.sharingScreen()) {
            if (DebugLevel >= 2) console.log("Teacher asked to stop sharing the screen");
            me.unshareScreen();
            $('#share-screen > i').removeClass('fa-blink');
        } else {
        
            navigator.mediaDevices
                .getDisplayMedia(ScreenShareConstraints)
                .then(stream => {
                    if (DebugLevel >= 2) console.log('Screen, application or browser tab has been shared');
                    
                    $('#share-screen > i').addClass('fa-blink');
                    animateCSS('#send-chat-text', 'heartBeat');
                    
                    stream.getVideoTracks()[0].onended = () => {
                        if (DebugLevel >= 2) console.log('Sharing screen ended');  
                        me.unshareScreen();
                        $('#share-screen > i').removeClass('fa-blink');
                    }

                    me.shareScreen(stream);

                }).catch(err => {

                    me.unshareScreen();
                    $('#share-screen > i').removeClass('fa-blink');

                    console.error("Error sharing screen: " + err);
                    return null; 
                });
        }

    });


    $('#export-status-button').on('click', function() {
    
        let t = $('#status-table').table2CSV(";");
        let blob = new Blob([t], {type: 'text/plain'});
        var dlink = document.createElement('a');
        dlink.download = 'booths.csv';
        dlink.href = window.URL.createObjectURL(blob);
        dlink.click();
        dlink.remove();
    });


    // Handle chronometer and timeout for batch activities
    var batchChrono = null;
    var batchTimeout = null;

    clearBatch = () => {

        if (batchChrono) batchChrono.clear();
        if (batchTimeout) clearTimeout(batchTimeout);
        
        $('#batch-display').addClass('hide');
        
        me.sendToAll({batch: { action: "clear", parameters: {} }});

        $('#audio-player').off('ended.sim');
        $('#audio-player').off('ended.con');

        if (DebugLevel >= 2) console.log("Batch cleared");
        appendLog("Batch cleared");

    }
    
    pauseBatch = () => {
        if (DebugLevel >= 2) console.log("Pause batch");
        if (batchChrono) batchChrono.pause();
    }
    
    resumeBatch = () => {
        if (DebugLevel >= 2) console.log("Resume batch");
        if (batchChrono) batchChrono.resume();
    }


    $('#simultaneous-batch,#consecutive-batch').on('click', (e) => {
        e.preventDefault();
        
        // type contains the event target id (simultaneous-batch, consecutive-batch)
        let type = (e.target.id == 'simultaneous-batch' ? 'SIM' : 'CON');
        
        if (DebugLevel >= 2) console.log("Trying to start a " + type + " batch");
    
        // check if there's any booth connected 
        // and verify if they've loaded
        let fileok = true;
        let n = 0;
        let err = false, t = "", m = "";
        
        let audioPlayer = $('#audio-player')[0];
        let duration = audioPlayer.duration;
        
        me.forEachConnectedBooth(booth => {
            n++;
            if (booth.registry.file != fileName || booth.registry.crc != fileCRC) fileok = false;
        });
        
        if (recording) {
            err = true;
            t = "Recorder busy";
            m = "Can't start an interpretation session while recording";
        } else if (!audioPlayer.paused) {
            err = true;
            t = "Player busy";
            m = "Can't start an interpretation session while the player is playing";
        } else if (n == 0) {
            err = true;
            t = "No booth connected";
            m = "There are no connected booths yet";
        } else if (!fileok) {
            err = true;
            t = "Audio file not ready on all booths";
            m = "You've not loaded an audio file or the audio file has not been sent to all booths yet";
        } else if (isNaN(duration) || duration == 0) {
            err = true;
            t = "Unsupported audio file";
            m = "Can't figure out the duration of the audio file you've uploaded (unsupported file type for this feature)";
        }


        if (err) {
            if (DebugLevel >= 2) console.log("The " + type + " batch cannot be started: " + t);
            bootbox.alert({
                centerVertical: true,
                title: t,
                message: m,
            });
            return;
        }
        
        if (DebugLevel >= 2) console.log("Scheduling a " + type + " batch...");
        appendLog("Scheduling a " + type + " batch...");

        
        var batchDuration = null;
        
        let now = new Date();
        
        let session = recordingIds.id;
                
        
        if (type == 'SIM') {
            bootbox.prompt({
                title: "Simultaneous translation session",
                message: "<div class='mb-2'>The recording will begin along with the audio playback and will continue past its end for the number of seconds you specify below. </div>",
                inputType: 'number',
                min: 0,
                locale: 'en	',
                value: Cookies.get('simultaneous-batch-delay') || SimultaneousBatchDefaultDelay,
                buttons: {
                    confirm: {
                        label: 'Start session',
                    },
                },
                callback: function (result) {
                    if (result === null) {
                        if (DebugLevel >= 2) console.log("Batch of type " + type + " aborted");
                        appendLog("Batch of type " + type + " aborted");
                        return;
                    }
                    if (DebugLevel >= 2) console.log("Batch of type " + type + " started");
                    appendLog("Batch of type " + type + " started");
                    
                    result = parseInt(result) || 0;
                    
                    Cookies.set('simultaneous-batch-delay', result, { expires: 365 });
                    
                    batchDuration = duration + result;
                    
                    if (DebugLevel >= 2) console.log("Batch in progress: triggering recorder start command");
                    $('#recorder-start').trigger('click');


                    if (DebugLevel >= 2) console.log("Batch in progress: scheduling the batch on all booths");
                    me.sendToAll({
                        batch: {
                            action: "simultaneous", 
                            parameters: {
                                delay: result,
                                duration: batchDuration,
                                file: fileName,
                                crc: fileCRC,
                                teacher: userName, 
                                session: session,
                                recordingMode: sessionRecordingMode,
                            }
                        }
                    });
 
                    
                    $('#batch-counter').html('--:--');
                    
                    batchChrono = new MyChrono(
                        100,
                        (t) => {
                            t = Math.floor(t / 10);
                            
                            if (batchDuration <= t) {
                                //batchChrono.stop();
                                batchChrono.clear();
                                t = batchDuration;
                            }
                            
                            $('#batch-counter').html(Math.floor(batchDuration - t).toMMSS());
                    });
                    
                    // Delay 1s audio player
                    if (DebugLevel >= 2) console.log("Batch in progress: triggering player start command (1s delay)");
                    setTimeout(() => {
                        $('#audio-player-play').trigger('click');
                        batchChrono.start()
                    }, 1000);
                    
                    $('#batch-type').html('Simultaneous');
                    $('#batch-display').removeClass('hide');
                    
                    
                    
                    // Append an event handler for the "onended" of the player
                    if (DebugLevel >= 3) console.log("Batch in progress: appending 'onended' event handler for current track");
                    $('#audio-player').on('ended.sim', function() {

                        if (DebugLevel >= 2) console.log("Batch in progress: the audio track is over. Recording for " + result + " more seconds.");
                    
                        batchTimeout = setTimeout(() => {
                            if (DebugLevel >= 2) console.log("Batch in progress: triggering a recorder stop command");
                            $('#recorder-stop').trigger('click');
                        }, result*1000);
                    });
                    
                },
            });        

        } else { 
            // type == 'CON'
            bootbox.prompt({
                title: "Consecutive translation session",
                message: "<div class='mb-2'>Audio playback will start immediately. Recording will begin at the end of playback and will last for the duration of the audio plus the number of seconds you set below. You can also enter a negative number of seconds to make the recording shorter than the original audio length.</div>",
                inputType: 'number',
                min: -parseInt(duration - 1),
                locale: 'en	',
                value: Cookies.get('consecutive-batch-delay') || ConsecutiveBatchDefaultDelay,
                buttons: {
                    confirm: {
                        label: 'Start session',
                    },
                },
                callback: function (result) {
                    if (result === null) {
                        if (DebugLevel >= 2) console.log("Batch of type " + type + " aborted");
                        appendLog("Batch of type " + type + " aborted");
                        return;
                    }
                    if (DebugLevel >= 2) console.log("Batch of type " + type + " started");
                    appendLog("Batch of type " + type + " started");

                    
                    result = parseInt(result) || 0;
                    
                    
                    batchDuration = duration + result;
                    
                    if (batchDuration < 0) {
                        
                        return false;
                    }

                    Cookies.set('consecutive-batch-delay', result, { expires: 365 });

                    
                    if (DebugLevel >= 2) console.log("Batch in progress: scheduling the batch on all booths");
                    me.sendToAll({
                        batch: {
                            action: "consecutive", 
                            parameters: {
                                delay: result,
                                duration: batchDuration,
                                file: fileName,
                                crc: fileCRC,
                                teacher: userName, 
                                session: session,
                                recordingMode: sessionRecordingMode,
                            }
                        }
                    });
                    
                    
                    
                    $('#batch-counter').html(batchDuration.toMMSS());
                    
                    batchChrono = new MyChrono(
                        100,
                        (t) => {
                            t = Math.floor(t / 10);
                            
                            if (batchDuration <= t) {
                                //batchChrono.stop();
                                batchChrono.clear();
                                t = batchDuration;
                            }
                            
                            $('#batch-counter').html(Math.floor(batchDuration - t).toMMSS());
                    });
                    
                    // Start audio player
                    if (DebugLevel >= 2) console.log("Batch in progress: triggering a player start command");
                    $('#audio-player-play').trigger('click');
                    
                    $('#batch-type').html('Consecutive');
                    $('#batch-display').removeClass('hide');
                    
                    // Append an event handler for the "onended" of the player
                    if (DebugLevel >= 3) console.log("Batch in progress: appending 'onended' event handler for current track");
                    $('#audio-player').on('ended.con', function() {
                    
                        if (DebugLevel >= 2) console.log("Batch in progress: the audio track is over. Recording will start delayed by 1s");
                    
                        // Delay 1s audio recorder
                        
                        setTimeout(() => {
                        
                            batchChrono.start();

                            if (DebugLevel >= 2) console.log("Batch in progress: triggering recorder start command. The recording will be automatically stopped after " + batchDuration + "s");                            
                            $('#recorder-start').trigger('click');
                            
                            batchTimeout = setTimeout(() => {
                                if (DebugLevel >= 2) console.log("Batch in progress: triggering a recorder stop command");
                                $('#recorder-stop').trigger('click');
                            }, batchDuration * 1000);
                        
                        
                        }, 1000);
                    
                    });


                },
                
            });           
        }
        
        
    
    });

    // ondevicechange event (webcam or headset has been plugged in or out)
    navigator.mediaDevices.ondevicechange = (e) => {
        appendLog("Device list change detected");
        animateCSS('#config-button', 'jello');
        handleDeviceListChange(e); // io-devices.js
    }

    // Reload device list when the config button is clicked    
    $('#config-button, #refresh-devices').on('click', function() {
        if (DebugLevel >= 3) console.log("enumerating devices");
        getDevices()
            .then(() => { 
                $('#config-panel').modal('show'); 
            })
            .catch(handleLocalMediaStreamError);
    });
    

    $('#select-video-source').on('change', () => {
        Cookies.set('teacher-video-source', $('#select-video-source').val(), { expires: 365 });
        setUserMediaConstraints(myMediaConstraints);
    });
    $('#select-audio-source').on('change', () => {
        Cookies.set('teacher-audio-source', $('#select-audio-source').val(), { expires: 365 });
        setUserMediaConstraints(myMediaConstraints);
    });
    $('#select-audio-output').on('change', () => {
        Cookies.set('teacher-audio-output', $('#select-audio-output').val(), { expires: 365 });
        changeAudioDestination($('#audio-player')[0]);
        
        changeAudioDestination(audioDestinationElement);
        
        me.forEachBooth(booth => {
            changeAudioDestination(booth.videoElement);
        });
    });
    
        
    /*
    * Booth media players controller
    *
    * Requests to activate booth media players are triggered as pseudo-events 
    * which are controlled in one place by this global event handler and sent
    * to the booths with a proper commant through the data channel
    */
    $(document).on('player-feedback', (event, data) => {
        let timestamp = event.timeStamp;
        let action = data.action;
        let params = data.parameters;
        let file = params.file;
        let crc = params.crc;
        
        
        switch (action) {
        case 'ready':
            if (DebugLevel >= 2) console.log("Asking all booths to load file '" + file + "'");
            me.sendToAll({player: {action: "load", parameters: {teacher: userName, file: file, crc: crc}}});
            
            $('.booth-mini-log').html();
            
            me.forEachConnectedBooth(booth => {
                $('#booth-'+booth.pin+' .booth-mini-log').html('&nbsp;<i class="fas fa-spinner fa-pulse"></i>');
            })
            break;
        case 'play':
            if (DebugLevel >= 2) console.log("Asking all booths to play file '" + file + "'");
            me.sendToAll({player: {action: "play", parameters: {teacher: userName, file: file}}});
            break;
        case 'pause':
            if (DebugLevel >= 2) console.log("Asking all booths to pause file '" + file + "'");
            me.sendToAll({player: {action: "pause", parameters: {teacher: userName, file: file}}});
            break;
        case 'stop':
            if (DebugLevel >= 2) console.log("Asking all booths to stop file '" + file + "'");
            me.sendToAll({player: {action: "stop", parameters: {teacher: userName, file: file}}});
            break;
        }
    });

    /*
    * Booth media players feedback controller
    *
    * Booth media player feedbacks received throung data channel are triggered 
    * as pseudo-events which are controlled in one place by this global event 
    * handler.
    */
    $(document).on('booth-player-feedback', (event, data) => {
        let timestamp = event.timeStamp;
        let pin = data.pin;
        let who = data.who;
        let action = data.action;
        let params = data.parameters;
        let file = params.file;
        let crc = params.crc;
        let mesg = params.mesg;
        
        switch (action) {
        case 'ready':
            me.getBooth(pin).registry.file = file;
            me.getBooth(pin).registry.crc = crc;
            
            if (DebugLevel >= 2) console.log("Booth " + pin + " (" + who + ") ready to play '" + file + "'");
            $('#booth-' + pin + " .booth-mini-log").html('<i class="fas fa-hand-point-right"></i>&nbsp;' + file);
            break;
        case 'started':
            if (DebugLevel >= 2) console.log("Booth " + pin + " (" + who + ") has started playing '" + file + "'");
            break;
        case 'paused':
            if (DebugLevel >= 2) console.log("Booth " + pin + " (" + who + ") has paused '" + file + "'");
            break;
        case 'ended':
            if (DebugLevel >= 2) console.log("Booth " + pin + " (" + who + ") has ended playing '" + file + "'");
            break;
        case 'error':
            break;
        case 'crc-error':
            $('#booth-' + pin + " .booth-mini-log").html('<b><i class="fas fa-exclamation-triangle"></i>&nbsp;UPLOAD FAILED. PLEASE TRY AGAIN</b>');
            console.warn("Booth " + pin + " (" + who + ") file '" + file + "' is corrupt");
            break;
        case 'http-error':
            console.error("Booth " + pin + " (" + who + "): HTTP error '" + mesg + "' loading file '" + file + "'");
            break;
        case 'loading':
            // We won't display 100% because messages from booths are asynchronous and
            // it may happen that 'ready' comes before 'loading.progress:100'
            if (params.progress >= 100) return;
            $('#booth-' + pin + " .booth-mini-log").html('Loading: ' + params.progress + '%');
            break;
        }
    });
    
    
    /*
    * Booth media recorders controller
    *
    * Requests to activate booth media recorders are triggered as pseudo-events 
    * which are controlled in one place by this global event handler and sent
    * to the booths with a proper commant through the data channel.
    */
    $(document).on('control-booth-recorder', (event, data) => {
    
        let now = new Date();
        let timestamp = event.timeStamp;
        let teacher = userName;

        if (DebugLevel >= 2) console.log("Recording ID is " + recordingIds.id);
        
        let parameters = {
            teacher: userName, 
            session: recordingIds.id,
            recordingMode: sessionRecordingMode,
        };
        
        switch (data.action) {
//      case 'save':
//          me.sendToAll({recorder: {action: "save", parameters: {teacher: userName, session: session}}});
//          break;
        case 'record':
            if (DebugLevel >= 2) console.log("Recorder: record");
            
            // Remove all existing handlers
            $('.download-booth-recording')
                .removeAttr('href')
                .off('click')
                .addClass('btn-success disabled')
                .removeClass('btn-warning');
            
            // Here we send a new session id
            me.sendToAll({recorder: {action: "record",        parameters: parameters}});
            break;
        case 'pause':
            if (DebugLevel >= 2) console.log("Recorder: pause");
            me.sendToAll({recorder: {action: "pause",         parameters: parameters}});
            break;
        case 'resume':
            if (DebugLevel >= 2) console.log("Recorder: resume");
            me.sendToAll({recorder: {action: "resume",        parameters: parameters}});
            break;
        case 'stop-and-save':
            if (DebugLevel >= 2) console.log("Recorder: stop and save");
            me.sendToAll({recorder: {action: "stop-and-save", parameters: parameters}});
            break;
        }
    });    

    /*
    * Booth media recorders feedback controller
    *
    * Booth media recorder feedbacks received throung data channel are triggered 
    * as pseudo-events which are controlled in one place by this global event 
    * handler.
    */    
    $(document).on('booth-recorder-feedback', (event, data) => {
        let timestamp = event.timeStamp;
        let pin = data.pin;
        let who = data.who;
        let action = data.action;
        let params = data.parameters;
        let file = params.file;
        let session = params.session;
        
        switch (action) {
        case 'rec-ready':
            //
            // We test if file is actually stored on server (stat=1)
            // In case, we enable the download button and add a download link.
            //
            setTimeout(() => {
                $.ajax({
                    type: "POST",
                    url: "/actions/session-get-blob",
                    data: { session: session, student: who, stat: 1 },
                    dataType: 'json'
                }).done( (d) => {
                    if (d.Result == "OK") {
                        // Now that we're sure that the file exists we add the download link
                        $('#download-booth-recording-'+pin)
                            .attr('href', "/actions/session-get-blob?session="+session+"&student="+who)
                            .removeClass('disabled btn-warning')
                            .addClass('btn-success')
                            .attr('data-original-title', "Download audio recording of this booth from the server"); // <= FORCE TOOLTIP
                    } else {
                        // WE SHOULD NEVER GET HERE
                        // The booth has sent the "blob ready" message, but we couldn't
                        // find it on the server: no idea what should we do here.
                    }
                }).fail( (e) => {

                    // The call has failed (timeout or server busy in handling the call)
                    // What should we do? Try again later?
                    // Add the download link in any case?
                    
                    console.error(e);
                });
            }, 1000);
            
            if (DebugLevel >= 2) console.log("Recording from booth " + pin + " (" + who + ") as '" + file + "'");
            appendLog("Recording from booth " + pin + " (" + who + ") has been uploaded to the server as '" + file + "'");
            break;
            
        case 'rec-upload-failed':
        case 'rec-upload-error':
        
            if (DebugLevel >= 2) console.log("Booth " + pin + " (" + who + ") could not upload recording");
            appendLog("Booth " + pin + " (" + who + ") could not upload recording");
        
            // The client could not upload it's recording
            // We set a warning icon and we program the button to
            // send the booth a message to attempt to upload again the recording
            // The button action is set up to fire once
            $('#download-booth-recording-'+pin)
                .removeClass('disabled btn-success')
                .removeAttr('href')
                .addClass('btn-warning')
                .attr('data-original-title', "Booth couldn't upload its recording to the server. Click to try again."); // <= FORCE TOOLTIP
                //.tooltip({title: });
            $('#download-booth-recording-'+pin)
                .one('click', () => {
                    me.send(pin, {
                        recorder: {
                            action: "upload",
                            parameters: {teacher: userName, session: session}
                        }
                    });
                    // Remove the warning and restore title
                    $('#download-booth-recording-'+pin)
                        .removeClass('btn-warning')
                        .addClass('btn-success disabled'); 
                });
                

            break;

        default:
            break;
        }
    
    });




    // Handle page close or reload
    $(window).on('beforeunload', function (e) {
        // Shows a warning 
        return e.originalEvent.returnValue;
    });
    
    $(window).on('unload', (e) => {
        console.warn("Page has been closed or reloaded - Closing sessions");
        
        sessionToken.unset();
        if (me) {
            me.forEachConnectedBooth(booth => { 
                me.send(booth.pin, {action: "leaving", message: "bye"});
            });
        }
            
        setTimeout(function() {
            if (me) me.destroy();
        }, 100);
    });
    
    
    $('#logon').on('click', function(e) {

        e.preventDefault();
        if ($(this).hasClass('disabled')) return;
        
        
        $('#logoff').addClass('disabled');
        $('#logon').addClass('disabled');
        
        
        me.logon(
            userName,
            classCode,
            (id) => { 
                appendLog('Youre connected as ' + userName + '[id = ' + id + ']');
                $('#logoff').removeClass('disabled');
                sessionToken.set();

            },
            (err) => { 
                appendLog(err);
                console.warn("Logon error: " + err);
                $('#logoff').addClass('disabled');
            }
        );
        
        
    });
    
    $('#logoff').on('click', function(e) {

        e.preventDefault();

        if ($(this).hasClass('disabled')) return;
        
        bootbox.confirm({
            title: "Do you really want to end this class?",
            message: "If you end the class now any recording in progress will be stopped and all booths will be disconnected. Do you really want to continue?",
            centerVertical: true,
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-danger'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-success'
                }
            },           
            callback: (r) => {
                if (!r) return;

                if (recording) $('#recorder-stop').trigger('click');

                activateClassCall(false);

                $('.listen-to-booth-indicator').removeClass('spinner-grow');
                $('.talk-to-booth-indicator').removeClass('spinner-grow');
                $('.booth-mini-log').html('');

                me.sendToAll({ info: { action: 'set-teacher-label', parameters: { value: false }}});
                me.muteSelf();
                me.muteAllBooths();

                me.sendToAll({flags: {value: 'clear all flags'}});
                clearAllFlags();
                
                sessionToken.unset();
                
                me.logoff();
                
                appendLog("You're now disconnected");
                
                $('#logon').removeClass('disabled');
                $('#logoff').addClass('disabled');
                
            }
        });
        
    });
    
    $('#quit').on('click', function(e) {
        e.preventDefault();
        
        sessionToken.unset();

        window.location.replace("/setup");
    });
    
    
    $("#chat-text").on("keypress", function(e) {
        if (e.which == 13) {
            $('#send-chat-text').trigger('click');
            return false;
        }
    });
    
    $('#send-chat-text').on('click', function() {
        let t = $('#chat-text').val().trim();
        
        if (t == "") return;
        
        
        // Beta/hidden feature
        if (t.startsWith('##')) {
            
            let n = t.substring(2);
            
            if (isNaN(n)) {
                switch(n) {
                case 'bw.low':
                case 'bw.medium':
                case 'bw.high':
                case 'bw.max':
                    let profile = n.substring(3);
                    setBandwidthProfile(profile);
                    setUserMediaConstraints(myMediaConstraints);
                    me.sendToAll({ profile: { value: profile}});
                    if (DebugLevel >= 2) console.log('Changing bandwidth profile to ' + profile);
                    break;
                case 'beta':
                    if (DebugLevel >= 2) console.log('Turning beta features on');
                    $('.beta-features').removeClass('beta-features');
                    break; 
                }
                
                return;
            }
            
            if (n=="0") {
                $('body').css('background', 'linear-gradient(0deg, rgba(2,0,36,1) 0%, rgba(56,9,121,1) 16%, rgba(0,212,255,1) 100%)');
            } else {
            
                $('body').css('background', 'url(' + BoothImageUrlTemplate.replace('{n}', n) + ') no-repeat center center fixed')
                $('body').css('background-size', 'cover');
            }
        
            return;
        }

        

        writeToChat(t);

        
        me.forEachConnectedBooth(booth => { 
            me.send(booth.pin, {chat: {text: t}});
        });
        
    });
    
    
    $('#recorder-stop').on('click', function(e) {
        if (DebugLevel >= 2) console.log("Record stop clicked");
        e.preventDefault();
        
        clearBatch();
        
        
        // Stop and save
        if ($(this).hasClass('disabled')) return;
        $('#recorder-start').removeClass('disabled');
        $('#recorder-stop').addClass('disabled');
            
        recording = false;
        
        
        recorderChrono.stop(); // stop timer            
        
        if (DebugLevel >= 2) console.log("Stop recording");
//      $("#recorder-start > i").removeClass("fa-square").addClass("fa-circle");


        // Send all connected booths the "stop and save" command
        $(document).trigger('control-booth-recorder', {
            date: Date.now(), 
            action: "stop-and-save",
//          parameters: { }
        });    
        
        
        // Get list of local booth elements that are recording
        // (they might not be actually connected at the moment)
        let boothsRecording = [];
        me.forEachBooth(booth => {
            if (booth.recorderStatus == 'recording') boothsRecording.push(booth.pin);
        });
        
        
        if (boothsRecording.length > 0) {
        
            $("label[for='recorder-save']").html("Encoding...");
            
            $("#recorder-save > i").removeClass("fa-cog").addClass("fa-sync fa-spin");
            
            let zip = new JSZip();

            // We have to manage some parallel asynchronous events
            // happening for each booth: encode the raw audio in WAV
            // format into a blob and zip it. Only after all the blobs
            // have been zipped into a new blob we can download it as
            // a zip file
            
            var blobPromises = [];
            
            if (DebugLevel >= 2) console.log("Collecting recordings");
            
            boothsRecording.forEach(pin => { 
                
                let booth = me.booths[pin];
            
                blobPromises.push(
                    booth.stopRecording().
                        then(p => {
                            if (p.mediaBlob.size == 0) {
                                // E' ancora possibile?
                            }
                            zip.file('rec-' + recordingIds.counter + "-" + (booth.who ? booth.who : booth.pin) + ".webm", p.mediaBlob);
                        }).catch( (err) => {
                            // GESTIRE ERRORI
                            console.warn("Error getting recording blob for booth " + booth.pin + " (" + booth.who + "):", err);
                       })
                ); 
            });
                

            // When everything has been zipped
            $.when.apply($, blobPromises).then(function() {

                zip.generateAsync({type:"blob"}).then( function(contents) { 
                
                    if (DebugLevel >= 2) console.log('Generating ZIP download link. Blob size is ' + contents.size);
                
                    var url = window.URL.createObjectURL(contents);
                
                    let name = recordingIds.id + "-streaming.zip";
                
                    $('#recorder-save').attr('href', url);
                    $('#recorder-save').prop('download', name);
                    
                    $("#recorder-save").removeClass("disabled");
                    $("#recorder-save > i").removeClass("fa-sync fa-cog fa-spin").addClass("fa-save");
                    
                    $("label[for='recorder-save']").html("Ready&hellip;");
                    
                    recordingIds.next(); // consume current recording session 
                   
                }, function (err) {
                    // GESTIRE UN EVENTUALE ERRORE
                    console.warn("Error while zipping: ", err)
                    
                    recordingIds.next(); // consume current recording session 
                });        
            });

        } else {
            appendLog("No one is recording");
            if (DebugLevel >= 2) console.log("No one is recording");
            $("#recorder-save > i").removeClass("fa-sync fa-cog fa-spin").addClass("fa-save"); 
            $("#recorder-save").addClass("disabled");
            $("label[for='recorder-save']").html("Save audio");
            
            recordingIds.next(); // consume current recording session 
        }        

    });
    
    $('#recorder-start').on('click', function(e) {
    
        if (DebugLevel >= 2) console.log("Record start clicked");
        e.preventDefault();

        // Start recording
        if ($(this).hasClass('disabled')) return;
        $('#recorder-start').addClass('disabled');
        $('#recorder-stop').removeClass('disabled');
        
    
        if (DebugLevel >= 2) console.log("Start recording");
        
        // Disable download buttons and clear recording download link on booths
        $('.download-booth-recording')
            .removeClass('btn-warning')
            .addClass('disabled btn-success')
            .attr('href', '#');

        $(document).trigger('control-booth-recorder', {
            date: Date.now(), 
            action: "record",
            parameters: { recordingMode: sessionRecordingMode, },
//          parameters: { session: null }
        });    
        

        let alive = 0;
        me.forEachConnectedBooth(booth => { 
            booth.startRecording();
            alive++;
        }, true);

        if (!alive) {
            appendLog("No one is connected");
            if (DebugLevel >= 2) console.log("No one is connected");
            return false;
        }
        if (DebugLevel >= 2) console.log("Recording started in " + alive + " connected booths");

        
        recording = true;
        
        recorderChrono.start(); // Start timer

//      $("#recorder-start > i").removeClass("fa-circle").addClass("fa-square");
        $("#recorder-save").addClass("disabled");
        $("#recorder-save > i").removeClass("fa-save").addClass("fa-cog fa-spin");

        $("label[for='recorder-save']").html("Recording&hellip;");
            
    });
    
    $('#recorder-save').on('click', function(e) {
        if ($(this).hasClass('disabled')) {
            e.preventDefault();
        } else {
            if (DebugLevel >= 2) console.log("Save audio file");
        }
    });    





    $('#clear-all-flags').on('click', function() {
        me.sendToAll({flags: {value: 'clear all flags'}});
        clearAllFlags();
    });
    
    // Copy contents of log board to clipboard
    $('#log-board').on('click', function() {
        animateCSS('#log-board-container', "bounce");
        let t = "";

        t += "<p><h4>Class info</h4>\n\n";
        t += "<span>Teacher: <b>" + userName + "</b></span><br/>\n";
        t += "<span>Class code: "+ (classCode ? "<b>" + classCode + "</b>": "<i>not set</i>") + "</span><br/>\n";
        t += "</p>\n\n";

        t += "<p><h4>Booths info</h4>\n<ul>\n";
        
        me.forEachBooth(booth => {
            let pin = booth.pin;
            let who = booth.who;
            let status = null;
            if (booth.connected()) {
                who = booth.who;
                status = 'connected';    
            } else {
                // if booth is not connected it has not yet declared its email adress
                // so we get it from its own html element
                who = $('#booth-' + pin).data('who');
                status = 'not connected';
            }
            t += "<li>" + who + " (pin "  +  pin + "): " + status + "</li>\n";
        });
        
        t += "</ul></p>\n\n";
        
        t += "<p><h4>Device setup info</h4>\n<ul>\n";
        
        let vs = $("#select-video-source option:selected").text() || $("#select-video-source option:first").text();
        let as = $("#select-audio-source option:selected").text() || $("#select-audio-source option:first").text();
        let ao = $("#select-audio-output option:selected").text() || $("#select-audio-output option:first").text();
        
        t += "<li>Video source: </b>" + vs + "</b></li>\n";
        t += "<li>Audio source: </b>" + as + "</b></li>\n";
        t += "<li>Audio output: </b>" + ao + "</b></li>\n";
        t += "<li>Audio mode: </b>" + $("#select-audio-mode   option:selected").text() + "</b></li>\n";
        t += "<li>Recording mode: </b>" + $("#select-record-mode  option:selected").text() + "</b></li>\n";
        
        t += "</ul></p>\n\n";
        
        t += "<p><h4>Session log</h4>\n\n";
        t += "<pre>";
        $(this).children().each(function() {
            t +=  $(this).text() + "\n";
        });
        t += "</pre></p>\n\n";

        if (DebugMode) {
            t += "<p><h4>Developer log</h4>\n\n<pre>"
            t += console.get();
            t += "</pre>\n</p>\n";
        }
        
        copyTextToClipboard(t, true);
    });

    
    


    // 
    // When class call is activated/deactivated
    // any private call is interrupted and all 
    // booths are muted
    //
    function activateClassCall(v = true) {

        me.sendToAll({
            info: {
                action: 'set-teacher-label',
                parameters: { value: v ? 'class call' : false }
            }
        });
        
        $(".talk-to-booth").prop("title", v ? "Give the floor to this booth" : "Talk to the booth");

        if ($('#class-call').hasClass('active') === v) return;
        $('#class-call').trigger('click');
    }
    $('#class-call').on('click', function() {

        $('.talk-to-booth-indicator').removeClass('spinner-grow');
//      $('.talk-to-booth').addClass('disabled');
//      $('.talk-to-booth').removeClass('active');
        $('.listen-to-booth-indicator').removeClass('spinner-grow');
        me.muteAllBooths();
        
        $(this).button('toggle');

        if ($(this).hasClass('active')) {
        
            me.sendToAll({info: { action: 'set-teacher-label', parameters: { value: 'class call' }} });
            $(".talk-to-booth").prop("title", "Give the floor to this booth");

$(".booth-signal").html('<i class="fas fa-bullhorn fa-2x" style="color: yellow"></i>');
        
            $(this).find('i').addClass('fa-blink-3x');
            me.unmuteSelf();
            if (DebugLevel >= 2) console.log('Class call activated');
            classCall = true;
            $('.booth-video').css('pointer-events', 'none');
//          $('.talk-to-booth').addClass('disabled');            
        } else {
        
            me.stopBoothBroadcast();
        
            me.sendToAll({ info: { action: 'set-teacher-label', parameters: { value: false }}});
            $(".talk-to-booth").prop("title", "Talk to the booth");

$(".booth-signal").html("");            
            
            $(this).find('i').removeClass('fa-blink-3x');
            me.muteSelf();
            if (DebugLevel >= 2) console.log('Class call ended');
            classCall = false;
            $('.booth-video').css('pointer-events', 'auto');
//          $('.talk-to-booth').removeClass('disabled');
        }
    });
    

    // Session recording mode
    $('#select-record-mode').on('change', () => {
        sessionRecordingMode = $('#select-record-mode').val();
        Cookies.set('record-mode', sessionRecordingMode, { expires: 365 });
    });


    // Select audio mode
    $('#select-audio-mode').on('change', () => {
        let mode = $('#select-audio-mode').val()
        Cookies.set('audio-mode', mode, { expires: 365 });
        
        boothsGain.disconnect();
        playerGain.disconnect();
        switch(mode) {
        case 'LR':
            boothsGain.connect(mixerNode, 0, 0);  // Booths: L
            playerGain.connect(mixerNode, 0, 1);  // Source: R
            break;
        case 'RL':
            boothsGain.connect(mixerNode, 0, 1);  // Booths: R
            playerGain.connect(mixerNode, 0, 0);  // Source: L
            break;
        default:
            boothsGain.connect(audioDestinationNode);
            playerGain.connect(audioDestinationNode);
            break;
        }
    });
    
    
    
    
    //
    // DOWNLOAD RECORDING SESSIONS
    //
    $('#get-sessions').on('click', function() {
        var sessions = [];
        $.ajax({
            type: "POST",
            url: "/actions/session-list",
            dataType: 'json'
        }).done( (d) => {
            if (d.Result == "OK") {
                sessions = d.Data;
console.log(sessions);
                
                if (sessions.length > 0) {
                    var l = "";
                    sessions.forEach(s => {
                    l = '<span style="display:inline-block" class="w-100 bg-light border-bottom"><a download title="This session contains ' + s.count + ' recordings" href="/actions/session-get-zip?session=' + s.name + '">' + s.name + '.zip</a><span class="float-right"><i class="far fa-user" aria-hidden="true"></i> &times; ' + s.count + ' </span></span><br/>' + l;
                    });
                    var m =
                        "<p>Before downloading the current session be sure " +
                        "all the booths have uploaded their recordings to the server.</p>" +
                        '<div class="border rounded bg-light" style="height:7.85rem; overflow-y: scroll">' +
                        l + "</div>";
                    bootbox.alert({
                        size: 'medium',
                        title: "Download booth recording sessions",
                        message: m,
                        centerVertical: true,
                        buttons: {
                            ok: {label: 'Close'}
                        }
                    });
                } else {
                    bootbox.alert({
                        title: "Download booth recording sessions",
                        message: "No recording session available yet",
                        centerVertical: true,
                    });
                }
            } else {
                bootbox.alert({
                    title: "Error accessing your recording session folder",
                    message: "<p>There was a problem accessing your recording session folder on the server: <em>" +  d.Message + "</em></p>",
                    centerVertical: true,
                });
            
                console.warn(d.Message);
            }
        }).fail( (e) => {
            // SHOULD NEVER GET HERE
            console.error(e);
        });    
    });
    

    $('#send-file-to-booths').on("change", function(e) {

        Array.from(e.target.files).forEach(function(file) {
            
            const blob = new Blob([ file ], { type: file.type });
            
            if (DebugLevel >= 2) console.log("Sending file '" + file.name + "'");
            
            let fd = new FormData();
            fd.append('file', blob, file.name);            

            $.ajax({
                type: 'POST',
                url: '/actions/session-put-file',
                data: fd,
                processData: false,
                contentType: false,
                dataType: "json",
            }).done((d) => {
                if (d.Result == "OK") {
                
                    appendLog("Sending download links for uploaded file");
                    
                    let t = '<span>Teacher has sent you this file: <a href="/actions/session-get-file?user='+userName+'&file=' + file.name + '" download="' + file.name + '">' + file.name + '</a> (&lArr; click)</span>';

                    me.forEachConnectedBooth(booth => { 
                        me.send(booth.pin, {chat: {text: t}});
                    });
                    
                    writeToChat('File <b>' + file.name + '</b> uploaded');

                    
                } else {
                    // ERROR
                    appendLog(d.Message, "log-item-error");
                    console.warn("Upload FAILED");                                                
                }

            }).fail(e => {
                // ERROR
                console.error(e);
            });            
            
            //datachannel.send({
            //    action: "sendfile", 
            //    filename: file.name,
            //    filetype: file.type,
            //    file: blob
            //});            
            
        });

       
    });    


    var togglePlayerSize = false;
    $('#player-container').on('dblclick', function() {
        let r = togglePlayerSize ? 1/2 : 2;
        togglePlayerSize = ! togglePlayerSize;
        $(this)
            .addClass('hide')
            .height($('#player-container').height() * r)
            .width($('#player-container').width() * r)
            .css('top', 'auto', 'bottom', '6px')
            .css('left', 'auto', 'right', '6px')
            .removeClass('hide');    
    });
  
  
    /////////////////////////////
    //                         //
    // BOOTH SPECIFIC CONTROLS //
    //                         //
    /////////////////////////////
    
    

    // Copy invitation link to clipboard
    $('#booths').on('click', '.invitation-link', function() {
        animateCSS('#' + $(this).prop('id'), 'heartBeat');
        copyTextToClipboard($(this).data('invitation-link'));
    });
    

    // Kick out (force disconnect)
    $('#booths').on('click', '.kick-out', function(e) {
        let pin = $(this).closest('.connection').data('pin');
        
        if ($(this).hasClass('disabled')) return;
        
        // KICK OUT
        bootbox.confirm({
            title: "Disconnect this booth",
            message: "Do you want to disconnet this booth?<br/>Please, do it only if the connection is stuck and the student is trying to reconnect but the system is telling that his/her PIN is already in use.",
            centerVertical: true,
            callback: (r) => {
                if (!r) return;
                let booth = me.getBooth(pin);
                booth.disconnect();
            }
        });
        
    });


    // Take a snapsnot
    $('#booths').on('click', '.take-snapshot', function(e) {
        let pin = $(this).closest('.connection').data('pin');
        let videoElem = $('#booth-video-' + pin).get(0);

        // ask hi-res snapshot to the booth
        // (might cause data channel to close unexpectedly)
        
        console.log("Requesting snapshot to booth " + pin);
        if (me.isBoothConnected(pin)) {
            let who = me.booths[pin].who;
            me.send(pin, {
                snapshot: {
                    value: 'take-snapshot',
                    parameters: {
                        filename: who.replace('@', '.') + '.png' 
                    }
                }
           });
        
        }
        
        return;
/*      
        if (me.isBoothConnected(pin)) {
            let who = me.booths[pin].who;
        
            takeSnapshotFromMediaStream(videoElem.srcObject, 3).then(r => {
                loadAndPlay(SoundSnapshot);
                downloadDataURL(r.url, who.replace('@', '.') + '.png');
            });    
        }
*/
    });
    
    
    //
    // Discrete listening
    //
    $('#booths').on('click', '.booth-video', function(e) {

        let pin = $(this).closest('.connection').data('pin');
        
        if (!me.isBoothConnected(pin)) return;
        
        if (classCall) {
            animateCSS('#class-call', 'heartBeat');
            return;
        }
        
        let listening = $(this).parent().parent().find('.listen-to-booth-indicator').hasClass('spinner-grow');

        $('.listen-to-booth-indicator').removeClass('spinner-grow');
        $('.talk-to-booth-indicator').removeClass('spinner-grow');
        $('.talk-to-booth').removeClass('active');
        me.muteAllBooths();
        me.muteSelf();
        me.sendToAll({ info: { action: 'set-teacher-label', parameters: { value: false }}});
        
        if (!listening) {
            $('#booth-'+pin+' .listen-to-booth-indicator').addClass('spinner-grow');
            $('.talk-to-booth').removeClass('disabled');
            me.unmuteBooth(pin);
        }
       
    });


    //
    // Teacher clicks to talk to a booth
    // stop talking to anyone unless we're in class call mode
    // if we were already talking return else start talking to the booth
    // 
    $('#booths').on('click', '.talk-to-booth', function() {
    
        // Get pin from data-pin attribute of ancestor
        let pin = $(this).closest('.connection').data('pin');
        let who = $(this).closest('.connection').data('who');
        
        
        // Return if this booth is not connected or, for some reason, the button has been disabled
        if ($(this).hasClass('disabled') || !me.isBoothConnected(pin)) return;
    
        // Check if we're already listening and/or talking
        let listening = $('#booth-'+pin+' .listen-to-booth-indicator').hasClass('spinner-grow');
        let talking = $('#booth-'+pin+' .talk-to-booth-indicator').hasClass('spinner-grow');
        

        // Stop broadcasting anyone if in class call mode
        if (classCall) {
            me.stopBoothBroadcast();
        }
        
        // Mute anyone else
        $('.talk-to-booth-indicator').removeClass('spinner-grow');
        me.sendToAll({ info: { action: 'set-teacher-label', parameters: { value: false }}});
        me.muteAllBooths();
        
        // Re-enable booth audio if we were listening
        if (listening) me.unmuteBooth(pin);
        
        
        // If we were already talking then we've clicked to stop talking
        if (talking) {
            // We don't mute ourselves if we are in class call mode
            if (! classCall) {
                me.muteSelf();
            } else {
                me.sendToAll({info: { action: 'set-teacher-label', parameters: { value: 'class call' }} });
            }
            return;
        }
        
        
        if (!listening) $('#booth-video-' + pin).trigger('click');
        $('#booth-'+pin+' .talk-to-booth-indicator').addClass('spinner-grow');
        me.unmuteSelfForBooth(pin);
        

        if (classCall) {
            //animateCSS('#class-call', 'heartBeat'); // PERCHE' QUI????
            me.stopBoothBroadcast();
            me.startBoothBroadcast(pin);
            me.unmuteBooth(pin);
        }
        
        
        // 
        me.forEachConnectedBooth((booth) => {
            me.send(
                booth.pin,
                { 
                    info: { action: 'set-teacher-label',
                    parameters: { value: 'Teacher is talking to ' + (booth.pin == pin ? 'you' : who) }
                }
            });
        });
        
    });



    $('#audio-player').on('ended', function() {
        if (! $('#player-container').hasClass('hide')) {
            $('#audio-player').attr('poster', "images/video-poster.jpg");
        }
    });


    $('#booths').on('click', '.download-booth-recording', (e) => {
        
        if ($(this).hasClass('disabled')) {
            e.preventDefault();
            return false;
        }

        $.get($(this).attr('href'));


        
        // Get pin from data-pin attribute of ancestor
        let pin = $(this).closest('.connection').data('pin');
    });

    
    $('#booths').on('click', '.booth-rec', function() {
        // Get pin from data-pin attribute of ancestor
        let pin = $(this).closest('.connection').data('pin');
        me.startRecording(pin);
    });

    $('#booths').on('click', '.booth-stop', function() {
        // Get pin from data-pin attribute of ancestor
        let pin = $(this).closest('.connection').data('pin');
        me.stopRecording(pin);
    });
    
    $('#booths').on('click', '.booth-down', function() {
        // Get pin from data-pin attribute of ancestor
        let pin = $(this).closest('.connection').data('pin');
        
        // ...
        // ...

    });    

    // Booth volume slider
    $('#booth-volume').on('input', function() {
        //boothsGain.gain.value = BoothsGainMax * $(this).val();
        boothsGain.gain.setValueAtTime(BoothsGainMax * $(this).val(), audioCtx.currentTime);
    });


    // Play test sound button on device control panel
    $('#play-test-sound').on('click', function() {
        playTestSound({sinkId: audioOutputSelect.value, audioUrl: SoundAudioTest});
    });


    
    //
    // 
    //  UTILITY FUNCTIONS
    //
    //
    function clearAllFlags(pin = false) {
    
        if (!pin) {
            $('.booth-video-container').css('background', 'transparent');
            $('.booth-flags').html('');
            
        } else {
            $('#booth-' + pin + ' .booth-video-container').css('background', 'transparent');
            $('#booth-' + pin + ' .booth-flags').html('');
        }
    }
    
    
    
    
    
});




function dragElement(id) {
  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  var elmnt = document.getElementById(id);
  if (elmnt) {
    // if present, the header is where you move the DIV from:
    document.getElementById(id).onmousedown = dragMouseDown;
  } else {
    return;
    // otherwise, move the DIV from anywhere inside the DIV:
    //elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {

    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {

    // stop moving when mouse button is released:
    document.onmouseup = null;
    document.onmousemove = null;
  }
}




function logToServer(timeStamp, logLevel, script, line, column, log) {

    if (!DebugMode || !DebugToServer) return;

    let fd = new FormData();
    fd.append('teacher', userName);
    fd.append('classCode', classCode);
    fd.append('timeStamp', timeStamp);
    fd.append('logLevel', logLevel);
    fd.append('script', script);
    fd.append('line', line);
    fd.append('column', column);
    fd.append('log', log);

    $.ajax({
        type: 'POST',
        url: '/actions/session-log',
        data: fd,
        processData: false,
        contentType: false,
        dataType: "json",
    }).done((d) => {
        if (d.Result != "OK") {
            // ERROR
            appendLog(d.Message, "log-item-error");
            
            console.owarn("Can't upload log: " + d.Message);
        }

    }).fail(e => {
        // ERROR
        console.oerror("Something else went wrong", e);
    });
}

































</script>

</head>
<body>


  <div class="container-fluid" style="">
    <div class="row mb-2 head-panel">


      <div class="col-sm-9 d-flex justify-content-between">
      
        <div class="d-flex flex-column mr-4" style="width: 18rem">
          <div class="display d-flex align-self-stretch h-100  align-content-center rounded ml-1 mt-2 mb-2" style="background-color: rgba(255,255,255,0.05)">
            <div class="align-self-center text-center w-100" >  
              <span style="font-size: 1.3rem; color: #FFFFD0" id="application-name">App</span><br/>
              <span style="font-size: 2.25rem" id="time">h:mm</span><br/>
              <span style="font-size: 0.8rem" id="date">day, dd/mm/yyyy</span>
            </div>
          </div>      
        </div>
  
        
        <!-- TOOLBAR: BEGIN -->
        <div class="align-self-stretch w-100">
              <div class="mt-2 mb-2 w-100">
              <button  id="logon"  class="btn btn-sm btn-primary mr-1">Start the class</button>
              <button  id="logoff" class="btn btn-sm btn-warning mr-1">End the class</button>
              <button  id="quit"   class="btn btn-sm btn-danger mr-1">Quit and create another class</button>
              
              
              <button id="config-button" class="ml-1 float-right btn btn-info" data-tooltip="tooltip" title="Show configuration panel"><i class="fas fa-cogs"></i></button>

              <button id="add-booth"     class="ml-1 float-right btn btn-secondary" data-tooltip="tooltip" title="Add another booth"><i class="fas fa-plus-circle"></i></button>

              
            </div>
            
            <div class="rounded border bg-light p-1 form-inline mb-2 unselectable">
            
              <div class="float-left form-inline align-items-start ">
              
                
                <!-- Player: begin -->
                <div id="player-controls" class="d-flex flex-row" style="">
                
                  <!-- Buttons and progress bar -->
                  <div>
                    <!-- Buttons -->
                    <div class="d-flex">
                      <div class="mr-1">
                        <label for="open-file-manager-button" class="label-tiny text-dark">Load</label>
                        <button  id="open-file-manager-button" class="player-control btn btn-success btn-main-toolbar" data-toggle="modal" data-target="#file-manager" >
                          <i data-html="true" data-tooltip="tooltip" title="Open the file manager and send a media file to connected booths.<br>It won't be played until you press play or start a sim/cons" class="fas fa-folder-open"></i>
                        </button>
                      </div>
                      
                      <div class="mr-1">
                        <label for="audio-player-play" class="label-tiny text-dark">Play</label>
                        <button  id="audio-player-play" class="player-control btn btn-primary btn-main-toolbar"><i class="fas fa-play"></i></button>
                      </div>
                      
                      <div class="mr-1">
                        <label for="audio-player-pause" class="label-tiny text-dark">Pause</label>
                        <button  id="audio-player-pause" class="player-control btn btn-primary btn-main-toolbar"><i class="fas fa-pause"></i></button>
                      </div>
                      
                      <div class="mr-0">
                        <label for="audio-player-stop" class="label-tiny text-dark">Stop</label> 
                        <button  id="audio-player-stop" class="player-control btn btn-primary btn-main-toolbar"><i class="fas fa-stop"></i></button>
                      </div>
                    </div>
                    
                    <!-- Progress bar -->
                    <div class="mt-auto">
                      <label class="label-small text-dark" for="audio-player-bar" id="audio-player-text">none</label>
                      <div class="progress" style="" id="audio-player-bar">
                        <div id="audio-player-progress" class="progress-bar bg-info" role="progressbar" style="width:100%;"></div>
                      </div>
                      <div id="audio-player-display" class="text-center text-dark" style="">00:00 / 00:00</div>
                    </div>

                  </div>
  


                  <!-- Volume slider -->
                  <div class="ml-0 teacher-vertical-slider-container" _style="position:relative; width: 20px; background: yellow"  >
                    <input 
                      title="Player volume"
                      data-tooltip="tooltip"
                      id="audio-player-volume"
                      type="range"
                      _style="height: 100px"
                      class="teacher-vertical-slider vertical-slider"
                      step="0.01" value="1" min="0" max="1">
                  </div>
  
  
                  <!-- Booth slider -->
                  <div class="ml-2 teacher-vertical-slider-container" _style="position:relative; width: 21px;     background: yellow">
                    <input 
                      title="Booth volume"
                      data-tooltip="tooltip"
                      id="booth-volume"
                      type="range"
                      _style="height: 100px"
                      class="teacher-vertical-slider vertical-slider"
                      step="0.01" value="1" min="0" max="1">
                  </div>   

                </div>
                <!-- Player: end -->


  
                <!-- Share audio   -->
                <div class="ml-3 mr-1 d-flex align-self-stretch align-items-center hidden" 
                     id="share-audio-div">
                  <div>
                    <label for="share-audio" class="label-tiny text-dark">Sharing</label>
                    <button id="share-audio" style="font-size: 1.5rem;" class="btn disabled"> 
                        <i class="fa fa-volume-up" data-tooltip="tooltip" title="You're sharing your PCs audio"></i>
                    </button>    
                  </div>
                </div>
  
                <!-- Screen share button -->
                <div class="ml-3 mr-1 d-flex align-self-stretch align-items-center beta-features">
                  <div>
                      <label for="share-screen" class="label-tiny text-dark">Share screen</label>
                      <button id="share-screen" style="font-size: 1.5rem;" class="btn btn-secondary">
                        <i class="fas fa-desktop" style="color: white" data-tooltip="tooltip" title="Share screen"></i>  
                      </button>
                  </div>
                </div>

                <!-- Audio share button -->
                <div class="beta-features ml-3 mr-1 d-flex align-self-stretch align-items-center">
                        <i class="fa fa-volume-up" color="black" data-tooltip="tooltip" title="Share audio"></i>  
                </div>
  
  
  
                <!-- Recorder: begin -->
                <div id="recorder-controls" class="d-flex flex-column ml-2 align-self-stretch" style="">
                  
                  <div class="d-flex">
                    <div class="mr-1">
                      <label for="recorder-start" class="label-tiny text-dark">Record</label>
                      <a id="recorder-start" class="btn btn-danger btn-main-toolbar" data-toggle="button" aria-pressed="false" ><i class="fas fa-circle" data-tooltip="tooltip" title="Start recording"></i>
                      </a>
                    </div>
  
                    <div class="mr-1">
                      <label for="recorder-stop" class="label-tiny text-dark">Stop Rec.</label>
                      <a id="recorder-stop" class="btn btn-danger btn-main-toolbar" data-toggle="button" aria-pressed="false" ><i class="fas fa-stop" data-tooltip="tooltip" title="Stop recording"></i>
                      </a>            
                    </div>
                    
                    <div class="mr-0">
                        <label for="recorder-save" class="label-tiny text-dark">Save audio</label>
                        <a id="recorder-save" class="btn btn-success btn-main-toolbar disabled" href="" >
                          <i class="fas fa-save" data-tooltip="tooltip" title="Collect and save streaming audio files"></i>
                        </a>
                    </div>
                  </div>
                  
                  <div class="text-dark text-center">
                     <span class="ml-auto mr-auto text-dark" id="recorder-chrono">00:00</span>
                  </div>
                  
                  
                  <div class="mt-2 text-dark mt-auto w-100">
                     <button id="get-sessions" class="btn btn-small btn-outline-secondary w-100 p-0 m-0" style="height: 22px; font-size: 0.8rem" data-tooltip="tooltip" title="Download booth recording sessions from server">Sessions</button>
                  </div>
  
                </div>
                <!-- Recorder: end -->
  
  
                <!-- Batch controls: begin -->
                <div id="batch-controls" class="d-flex flex-column ml-3 align-self-stretch" style="position: relative; width: 110px">
  
                  <div class="">
                    <label for="simultaneous-batch" class="label-tiny text-dark">Sim. session</label>
                    <a id="simultaneous-batch" style="wiadth: 6.5rem" class="w-100 btn btn-success  btn-sm" href="" data-tooltip="tooltip" title="Start a simultaneous interpreting session and automatically record booth outputs">Start sim.</a>
                  </div>
                  
                  <div class="mt-auto">
                    <label for="consecutive-batch" class="label-tiny text-dark ">Cons. session</label>
                    <a id="consecutive-batch" style="wiadth: 6.5rem" class="w-100 btn btn-sm btn-success" href="" data-tooltip="tooltip" title="Start a consecutive interpreting session and automatically record booth outputs">Start cons.</a>
                  </div>
  
                  <div class="rounded border bg-success text-light w-100 h-100 hide" style="position: absolute; left: 0; top: 0" id="batch-display">
                    <div class="text-center"><span class="fa-blink" id="batch-type">Simultaneous</span></div>
                    <div class="text-center mt-2"><span style="font-size: 2rem"  id="batch-counter">00:00</span></div>
                  </div>
                  
                </div>
                <!-- Batch controls: end -->
  
  
  
              </div>
              
  
              <!-- -->
              <div class="ml-auto d-flex align-self-stretch align-items-center" style="">
                <div>
                  <label for="clear-all-flags" class="label-tiny text-dark">Check booths</label>
                  <button id="check-booths-button" style="font-size: 1.5rem;" class="btn btn-info ml-0" data-toggle="modal" data-tooltip="tooltip" data-target="#status-dialog" title="Check booths status">
                    <i class="fas fa-tasks"></i>
                  </button>    
                </div>
                <div>
                  <label for="clear-all-flags" class="label-tiny text-dark">Clear all flags</label>
                  <button id="clear-all-flags" style="font-size: 1.5rem;" class="btn btn-secondary ml-1" data-tooltip="tooltip" title="Clear all flags">
                    <i class="far fa-bell-slash"></i>
                  </button>    
                </div>
                <div> 
                  <label for="class-call" class="label-tiny text-dark">Class call</label>
                  <button id="class-call" style="font-size: 1.5rem;" class="btn btn-warning ml-1">
                    <i class="fas fa-bullhorn" style="color: yellow" data-tooltip="tooltip" title="Class call (talk to the booths)"></i>  
                  </button>
                </div>
              </div>            
              <!-- -->
              
  
              
  
            
            </div>
        </div>  
        <!-- TOOLBAR: END -->
        
      </div>      
      
      <div class="col-sm-3 pl-3 pt-2 mb-2 pr-3">
        <div id="log-board-container" class="w-100 h-100 border rounded bg-info">
      
          <div id="log-board" class="h-100 unselectable cursor-pointer"></div>
        </div>
      
      </div>
    </div>  
        
    
    <div class="row">
      <div class="col-sm-9" style="height: calc(100vh - 200px); overflow-y: auto">

<div 
    style="position: absolute; left: 1px; top: calc( 50% - 0.85rem - 1px ); height: calc( 1.7rem + 2px );">
    <button title="Enlarge booths" class="btn btn-xs btn-outline-light" style="width: 1rem; margin-bottom: 1px" id="enlarge-booths" data-tooltip="tooltip">+</button><br/>        
    <button title="Shrink booths"class="btn btn-xs btn-outline-light" style="width: 1rem; margin-top: 1px" id="shrink-booths" data-tooltip="tooltip">-</button><br/>
</div>      
        <!-- BOOTHS HERE!!! -->
        <div class="d-flex flex-wrap align-content-start justify-content-center h-100 p-0 m-0"  id="booths">





        
        </div>
        
      </div>
    
      <div class="col-sm-3">
        <div class="card">
          <div class="card-header ">
            Chat&nbsp;
            <div class="float-right">
            
                <div style="" class="custom-control custom-control-right custom-checkbox custom-control-inline" data-tooltip="tooltip" data-html="true" title="<b>Checked</b><br>all messages are public.<br><b>Unchecked</b><br>booth messages readable only by teacher, teacher messages public">
                    <input type="checkbox" class="custom-control-input " id="shared-chat" checked />
                    <label class="custom-control-label" for="shared-chat">Shared</label>
                </div>

                





                
            </div>
            
            
          </div>
          <div class="card-body" id="chat-board" style="padding: 4px;overflow-y: scroll; max-height: calc(100vh - 270px); height: calc(100vh - 270px)"></div>

          <div class="card-footer border-top-0 p-0">
          
            <div class="form-inline" >
            
              <div class="input-group w-100">
                <div class="input-group-prepend">
                    <div class="input-group-text cursor-pointer unselectable pl-1 pr-1" id="emoji-picker"><i class="far fa-smile"></i></div>
                </div>
                <input type="text"  class="form-control" id="chat-text" placeholder="Type text here...">
                
                <div class="input-group-append">
                
                  <button  id="send-chat-text" class="bg-primary text-light input-group-text p-1" data-tooltip="tooltip" title="Send a message to each connected booth" style="width: 1.75rem"><i class="far fa-paper-plane"></i></button>                
                
                  <label id="send-file-to-booths-button" class="cursor-pointer input-group-text p-1 bg-success text-light" style="width: 1.75rem" data-tooltip="tooltip" title="Send a document to each connected booth" for="send-file-to-booths"><i class="fas fa-file-upload"></i></label>
                </div>
                
              </div>
              
              <!--button  id="send-chat-text" class="hide btn btn-primary ml-auto" style="width:2.5rem" data-tooltip="tooltip" title="Send a message to each connected booth"><i class="far fa-paper-plane" style="margin-left:-2px" ></i></button-->
              
              <!--label _id="send-file-to-booths-button" data-tooltip="tooltip" class="ml-auto btn btn-small btn-success" title="Send a document to each connected booth" style="width:2rem" for="send-file-to-booths">
                <i class="fas fa-file-upload"></i>
              </label-->
              <input type="file" name="file" id="send-file-to-booths" class="hidden-input" />
            </div>  

         
          
          </div>
        </div>
      </div>
    </div>

    <div class="connection" id="teacher">
      <div class="d-flex justify-content-center" style="position: relative">
        <video class="video-small mirrored" id="teacher-video" width="160" height="120" poster="images/teacher-poster.jpg"></video>
        <div style="position: absolute; right: 2; bottom: 2">
            <button class="btn btn-sm btn-outline-light" style="width:2.25rem" id="teacher-video-toggle"><i class="fas fa-video"></i></button>
        </div>
      </div>
    </div>


    <div class="hide rounded" id="player-container" title="Double click to resize">
        <video id="audio-player" poster="images/video-poster.jpg"></video>
    </div>

    
  </div>


  <!-- BOOTH PROTOTYPE: BEGIN -->
  <div id="connection-prototype" class="connection ml-1 mb-1" style="display: none">
    <div class="card w-100 border rounded">
    
      <div class="card-header text-white bg-info booth-header">
        <span class="invitation-link float-left mt-1 unselectable cursor-pointer show-tooltip" style="display:inline-block" data-tooltip="tooltip" title="Click to copy the invitation link"><i class="fas fa-link"></i></span>
        <span class="booth-name float-left ml-1 ellipsis unselectable show-tooltip" data-html="true" data-placement="top" data-tooltip="tooltip"></span>&nbsp;
        <span class="take-snapshot float-right unselectable mt-1 show-tooltip" data-tooltip="tooltip" title="Take a snapshot" style="display:inline-block"><i class="fas fa-camera"></i></span>&nbsp;
      </div>
      
      <div class="card-body position-relative">
        <div class="booth-video-container d-flex justify-content-center align-items-center mb-1" >
          <div class="booth-connection "></div>
          <div class="booth-signal absolute-middle"></div>
          <div class="booth-flags absolute-middle" ></div>
          <div class="listen-to-booth-indicator text-brightred" style="position: absolute; top: 2px; right: 2px;" role="status"></div>
          <div class="talk-to-booth-indicator text-warning" style="position: absolute; top: 2px; left: 2px;" role="status"></div>
          <div class="booth-mini-log ellipsis label-small m-l-1 m-r-1" style="position: absolute; bottom: 1px; left: 1px; right: 1px"></div>
        </div>
        
        <div class="d-flex justify-content-center mb-0">
          <video class="video-normal booth-video cursor-pointer show-tooltip"
             disablePictureInPicture 
             width="240" height="180"
             data-tooltip="tooltip" title="Click to listen to/mute the booth."></video>
         </div>
      </div>
      
      <div class="card-footer d-flex justify-content-between align-items-center">
          <div class="">
            <button class="talk-to-booth btn btn-sm btn-success disabled show-tooltip" data-tooltip="tooltip" title="Talk to the booth"><i class="fas fa-headset"></i></button>
            &nbsp;
          </div>
          <div class="">
            <button class="disabled kick-out btn btn-sm btn-danger text-light show-tooltip" data-tooltip="tooltip" title="Force disconnection if connection is stuck"><i class="fas fa-skull"></i></button>
            <a class="disabled download-booth-recording btn btn-sm btn-success show-tooltip" download data-tooltip="tooltip" title="Download recording"><i class="fas fa-save"></i></a>
          </div>
      </div>
    </div>
  </div>
  <!-- BOOTH PROTOTYPE: END -->

 



<!-- DIALOGS --> 
  
  
  
<!-- File manager dialog: begin -->
<!-- Modal -->
<div class="modal fade" id="file-manager" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">File manager</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="file-manager-close-button-1">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center w-100" style="position:absolute;top:0;left:0; font-size: 0.9rem">Upload media files to the server. Send them to the booths by clicking on the <i class="far fa-hand-point-right"></i> icon&hellip;</div>
        <div class="m-2 bg-light" id="file-list" style="height: 252px; overflow-y: scroll; position: relative;">
        
        
        </div>
        <form method="post" class="m-2" action="" enctype="multipart/form-data" id="file-upload-form">     
        
            <div class="d-flex" >
              <div class="custom-file">
                <input data-tooltip="tooltip" title="" type="file" class="custom-file-input cursor-pointer" id="file-upload" name="file-upload" accept="">
                <label class="custom-file-label" for="file-upload" >Choose file</label>
              </div>
              
              <button class="btn btn-success ml-1" style="width: 8.5rem" id="file-upload-button" data-tooltip="tooltip" title="Upload the selected file to the server">Upload</button>
                
            </div>
        
        </form>
        <div class="m-2 p-2 bg-light" id="file-manager-log"></div>
      </div>
      <div class="modal-footer">
        <div class="mr-auto" id="share-audio-button">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="share-audio-button">Share PC audio instead</button>
        </div>      
        <div class="mr-auto" id="loading-stats"></div>

        <button class="btn btn-outline-success ml-auto"  id="file-list-refresh-button" data-html="true" data-tooltip="tooltip" title="Refresh the file list (may be needed if you've uploaded a file in another class)"><i class="fas fa-sync"></i> &nbsp; Refresh list</button>
      
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="file-manager-close-button-2">Close</button>
      </div>
    </div>
  </div>
</div> 
<!-- File manager dialog: end -->   
  
  
  
  
  
<!-- Config dialog: begin -->
<!-- Modal -->
<div class="modal fade" id="config-panel" tabindex="-1" role="dialog" aria-labelledby="config-panelTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Configuration</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      
    <form class="form">

      <div class="form-group">
        <label for="select-video-source">Select camera:</label>
        <div class="input-group">
          <div class="input-group-prepend">
            <div class="input-group-text"><i class="fas fa-video"></i></div>
          </div>
          <select class="form-control" id="select-video-source"></select>
        </div>
      </div>
      
  
      <div class="form-group">
        <div class="d-flex" >
          <label for="select-audio-source" class="nowrap">Select and test microphone:</label>
          <div class="w-100 ml-1" style="height: 24px; padding: 0;">
            <canvas class="w-100  border rounded" style="margin-top: 2px" height=24 id="vumeter"></canvas>
          </div>
        </div>
        
        <div class="input-group">
          <div class="input-group-prepend">
            <div class="input-group-text"><i style="width:1em" class="fas fa-microphone"></i></div>
          </div>
          <select class="form-control" id="select-audio-source"></select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="select-audio-output">Select audio output:</label>
        <div class="input-group">
          <div class="input-group-prepend">
            <div class="input-group-text"><i style="width:1em"   class="fas fa-headphones-alt"></i></div>
          </div>
          <select class="form-control" id="select-audio-output"></select>&nbsp;
          <div title="Play a test sound" class="btn btn-outline-success" id="play-test-sound"><i style="margin-top: 4px" class="fas fa-music"></i></div>
        </div>      
      </div>

      <div class="form-group">
        <label for="select-audio-mode">Audio mode:</label>
        <div class="input-group">
          <div class="input-group-prepend">
            <div class="input-group-text"><i style="width:1em"   class="fas fa-random"></i></div>
          </div>
          <select class="form-control" id="select-audio-mode">
            <option value="no">Normal mixed stereo audio (no split audio)</option>
            <option value="LR">Booth on Left channel, source on right channel</option>
            <option value="RL">Source on Left channel, booth on right channel</option>
          </select>
        </div>      
      </div>


      <div class="form-group">
        <label for="select-record-mode">Session recording mode:</label>
        <div class="input-group">
          <div class="input-group-prepend">
            <div class="input-group-text"><i style="width:1em"   class="fas fa-circle"></i></div>
          </div>
          <select class="form-control" id="select-record-mode">
            <option value="default">Record just booth audio</option>
            <option value="split">Record booth on Left channel, source on Right channel</option>
            <option value="interview">Interview (booth on L, teacher on R)</option>
            <option value="video">Record booth audio and video</option>
          </select>
        </div>      
      </div>
      

    </form>
    
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info mr-auto" id="refresh-devices">Refresh device list</button>
        <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
      </div>
    </div>
    
  </div>
  
</div> 
<!-- Config dialog: end -->  
  




<!-- Booth status dialog: begin -->
<!-- Modal -->
<div class="modal fade" id="status-dialog" data-toggle="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" style="max-width: 80%">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Booths status</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table id="status-table" class="table table-sm table-striped table-borderless">
          <thead>
            <tr>
              <th width="2%">#</th>  
              <th width="23%">Booth</th>
              <th width="55%">Player status</th>
              <th width="20%">Recorder status</th>
            </tr>
          </thead>
          <tbody id="status-log">
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="export-status-button">Export</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div> 
<!-- File manager dialog: end -->   


  
</body>
</html>
